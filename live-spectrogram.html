<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Live Microphone Spectrogram (Scrolling) ‚Äî Colormaps</title>
<style>
  :root{
    --bg:#0b1020; --panel:#0f1730; --fg:#e8f1ff; --muted:#9fb4d1; --line:#1f2a54;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header,footer{padding:.75rem 1rem;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#101835,#0b1020)}
  footer{border-top:1px solid var(--line);border-bottom:none;background:linear-gradient(0deg,#101835,#0b1020);font-size:.9rem;opacity:.9}
  main{display:grid;grid-template-columns:1fr 340px;gap:12px;padding:12px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  .row{display:flex;align-items:center;gap:8px;justify-content:space-between;margin:.35rem 0}
  label{font-size:.9rem;color:var(--muted)}
  input[type="range"],select,button{accent-color:#3ea0ff}
  button{background:#152143;color:var(--fg);border:1px solid #2a3d7a;border-radius:.6rem;padding:.5rem .8rem;cursor:pointer}
  button.primary{background:#1a3a6b;border-color:#345ea2}
  #wrap{position:relative}
  #spec{width:100%;height:calc(100vh - 230px);background:#061024;border:1px solid var(--line);border-radius:12px;display:block}
  .axis{position:absolute;pointer-events:none;color:#cfe3ff80;font-size:12px}
  #yticks{left:8px;top:8px}
  #xticks{right:12px;bottom:8px;text-align:right}
  .meter{height:10px;background:#101a38;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .meter>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#3a8bd8,#7cd2ff)}
  .hint{color:var(--muted);font-size:.9rem}
  .swatch{width:100%;height:10px;border-radius:6px;border:1px solid #2a3d7a}
</style>
</head>
<body>
<header>
  <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
    <div style="font-weight:700;font-size:1.1rem">Live Mic Spectrogram</div>
    <div class="hint">Scrolling x-axis (time) ‚Ä¢ Select fun colormaps ‚Ä¢ Adjustable FFT & freq range.</div>
  </div>
  <div style="display:flex;gap:.5rem;flex-wrap:wrap">
    <button id="start" class="primary">‚ñ∂ Start</button>
    <button id="pause">‚è∏ Pause</button>
    <button id="save">üíæ Save PNG</button>
  </div>
</header>

<main>
  <div id="wrap" class="panel" style="position:relative">
    <canvas id="spec" width="1400" height="600" aria-label="Spectrogram canvas"></canvas>
    <div id="yticks" class="axis"></div>
    <div id="xticks" class="axis"></div>
  </div>

  <div class="panel">
    <div style="font-weight:700;margin-bottom:.25rem">Settings</div>

    <div class="row">
      <label for="seconds">Time window (s)</label>
      <input id="seconds" type="range" min="2" max="12" step="1" value="6">
      <span id="secondsVal">6</span>
    </div>

    <div class="row">
      <label for="fft">FFT size</label>
      <select id="fft">
        <option value="1024">1024</option>
        <option value="2048" selected>2048</option>
        <option value="4096">4096</option>
      </select>
    </div>

    <div class="row">
      <label for="fmin">Min freq (Hz)</label>
      <input id="fmin" type="range" min="20" max="2000" step="10" value="100">
      <span id="fminVal">100</span>
    </div>

    <div class="row">
      <label for="fmax">Max freq (Hz)</label>
      <input id="fmax" type="range" min="1000" max="20000" step="100" value="8000">
      <span id="fmaxVal">8000</span>
    </div>

    <div class="row">
      <label for="dyn">Dynamic range (dB)</label>
      <input id="dyn" type="range" min="30" max="120" step="5" value="80">
      <span id="dynVal">80</span>
    </div>

    <div class="row">
      <label for="logy">Log frequency axis</label>
      <input id="logy" type="checkbox" checked>
    </div>

    <hr style="border:0;border-top:1px solid #20325e;opacity:.6;margin:10px 0">

    <div class="row">
      <label for="cmap">Colormap</label>
      <select id="cmap">
        <option value="viridis" selected>viridis</option>
        <option value="plasma">plasma</option>
        <option value="inferno">inferno</option>
        <option value="magma">magma</option>
        <option value="cividis">cividis</option>
        <option value="turbo">turbo</option>
        <option value="rainbow">rainbow</option>
        <option value="heat">heat</option>
        <option value="grayscale">grayscale</option>
      </select>
    </div>
    <div class="row">
      <label for="invert">Invert</label>
      <input id="invert" type="checkbox">
    </div>
    <div class="row">
      <label for="gamma">Contrast (gamma)</label>
      <input id="gamma" type="range" min="0.5" max="2.0" step="0.05" value="1.0">
      <span id="gammaVal">1.0</span>
    </div>
    <div class="row">
      <div class="swatch"><canvas id="swatch" width="300" height="10"></canvas></div>
    </div>

    <div class="row">
      <label>Mic level</label>
      <div class="meter" style="flex:1"><span id="lvl"></span></div>
    </div>

    <div class="hint">Use headphones to avoid feedback ‚Ä¢ If it looks dark, reduce dynamic range or raise mic gain.</div>
  </div>
</main>

<footer>
  <div>WebAudio + Canvas ‚Ä¢ Real‚Äëtime STFT ‚Ä¢ Selectable colormaps</div>
  <div class="hint">All audio stays local in your browser.</div>
</footer>

<script>
/* ======== UI refs ======== */
const canvas = document.getElementById('spec');
const ctx     = canvas.getContext('2d', { alpha:false });
const yticks  = document.getElementById('yticks');
const xticks  = document.getElementById('xticks');

const startBtn = document.getElementById('start');
const pauseBtn = document.getElementById('pause');
const saveBtn  = document.getElementById('save');

const seconds   = document.getElementById('seconds');
const secondsVal= document.getElementById('secondsVal');
const fftSel    = document.getElementById('fft');
const fminSl    = document.getElementById('fmin');
const fmaxSl    = document.getElementById('fmax');
const dynSl     = document.getElementById('dyn');
const logyChk   = document.getElementById('logy');
const lvlBar    = document.getElementById('lvl');

const cmapSel   = document.getElementById('cmap');
const invertChk = document.getElementById('invert');
const gammaSl   = document.getElementById('gamma');
const gammaVal  = document.getElementById('gammaVal');
const swatch    = document.getElementById('swatch');
const swctx     = swatch.getContext('2d');

secondsVal.textContent = seconds.value;

document.getElementById('fminVal').textContent = fminSl.value;
document.getElementById('fmaxVal').textContent = fmaxSl.value;
document.getElementById('dynVal').textContent  = dynSl.value;

dynSl.oninput   = ()=> (document.getElementById('dynVal').textContent  = dynSl.value);
seconds.oninput = ()=> secondsVal.textContent = seconds.value;
fminSl.oninput  = ()=> (document.getElementById('fminVal').textContent = fminSl.value, rebuildYmap());
fmaxSl.oninput  = ()=> (document.getElementById('fmaxVal').textContent = fmaxSl.value, rebuildYmap());
logyChk.onchange = ()=> rebuildYmap();
cmapSel.onchange = ()=> buildPalette();
invertChk.onchange = ()=> buildPalette();
gammaSl.oninput   = ()=> { gammaVal.textContent = gammaSl.value; };
gammaSl.onchange  = ()=> buildPalette();

/* ======== Audio ======== */
let audioCtx, analyser, mic, gain;
let freqBins, timeBuf;
let running=false, paused=false;

async function initAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const stream = await navigator.mediaDevices.getUserMedia({
    audio: {echoCancellation:false, noiseSuppression:false, autoGainControl:false},
    video:false
  });
  mic = audioCtx.createMediaStreamSource(stream);
  gain = audioCtx.createGain();
  analyser = audioCtx.createAnalyser();
  setAnalyserFFT(+fftSel.value);
  analyser.smoothingTimeConstant = 0.0; // crisp frames
  analyser.minDecibels = -110;
  analyser.maxDecibels = -10;
  mic.connect(gain).connect(analyser);
}

function setAnalyserFFT(fftSize){
  if(!audioCtx) return;
  analyser.fftSize = fftSize;
  freqBins = new Float32Array(analyser.frequencyBinCount);
  timeBuf  = new Float32Array(analyser.fftSize);
  rebuildYmap();
}
fftSel.onchange = ()=> setAnalyserFFT(+fftSel.value);

/* ======== Y-axis mapping (log/linear) ======== */
let y2bin = null, y2frac = null;
function rebuildYmap(){
  if(!audioCtx || !analyser) return;
  const H = canvas.height|0;
  y2bin  = new Float32Array(H);
  y2frac = new Float32Array(H);

  const fmin = +fminSl.value; const fmax = +fmaxSl.value;
  const sr   = audioCtx.sampleRate; const binHz = sr / analyser.fftSize;

  for(let y=0;y<H;y++){
    const t = y/(H-1);
    const f = logyChk.checked ? fmax * Math.pow(fmin/fmax, t) : fmax - t*(fmax - fmin);
    const idx = Math.max(0, Math.min(analyser.frequencyBinCount-1, f/binHz));
    const i0 = Math.floor(idx);
    y2bin[y]  = i0;
    y2frac[y] = idx - i0;
  }
  drawYTicks();
}

function drawYTicks(){
  const H = canvas.height|0;
  const fmin = +fminSl.value, fmax = +fmaxSl.value;
  const ticks = logyChk.checked
    ? [100,200,300,500,1000,2000,3000,5000,8000,12000,16000,20000].filter(f=>f>=fmin && f<=fmax)
    : Array.from({length:6}, (_,k)=> Math.round(fmin + k*(fmax-fmin)/5));
  let html = '';
  for(const f of ticks){
    const pos = logyChk.checked ? (Math.log(fmax)-Math.log(f))/(Math.log(fmax)-Math.log(fmin)) : (fmax-f)/(fmax-fmin);
    const y = Math.round(pos*(H-1))+8;
    html += `<div style="position:absolute;left:0;top:${y}px;">${f>=1000?(f/1000).toFixed(f%1000?1:0)+'k':f} Hz</div>`;
  }
  yticks.innerHTML = html;
}

function drawXTicks(){
  const W = canvas.width|0; const secs = +seconds.value; const tps = W/secs; // px per second
  const maxTicks = Math.min(secs, 12);
  let html = '';
  for(let s=0;s<=maxTicks;s++){
    const x = W - Math.round(s*tps);
    html += `<div style="position:absolute;right:0;bottom:${8+16*s}px;">${s}s</div>`;
  }
  xticks.innerHTML = html;
}
seconds.onchange = ()=> drawXTicks();
window.addEventListener('resize', ()=> setTimeout(()=>{ drawXTicks(); drawYTicks(); }, 50));

/* ======== Colormaps (LUT builder) ======== */
const CMAPS = {
  viridis : ['#440154','#414487','#2a788e','#22a884','#7ad151','#fde725'],
  plasma  : ['#0d0887','#7e03a8','#cc4778','#f89441','#f0f921'],
  inferno : ['#000004','#420a68','#932667','#dd513a','#fca50a','#fcffa4'],
  magma   : ['#000004','#3b0f70','#8c2981','#de4968','#fca636','#fcfdbf'],
  cividis : ['#00204c','#2e4a7f','#56799c','#8aa8a1','#c1d07f','#f9e255'],
  turbo   : ['#30123b','#4144a5','#2ec7e0','#32f2a8','#a6e630','#f9c50a','#f06a10','#d92120','#7c1d13'],
  rainbow : ['#0000ff','#00ffff','#00ff00','#ffff00','#ff0000'],
  heat    : ['#000000','#ff0000','#ffff00','#ffffff'],
  grayscale: ['#000000','#ffffff']
};

let LUT = new Uint8Array(256*3);
function hex2rgb(h){ const n=parseInt(h.slice(1),16); return [(n>>16)&255, (n>>8)&255, n&255]; }
function lerp(a,b,t){ return a + (b-a)*t; }
function buildPalette(){
  const name = cmapSel.value; const inv = invertChk.checked; const gamma = parseFloat(gammaSl.value);
  const stops = CMAPS[name].map(hex2rgb);
  // Build 256-sample table
  for(let i=0;i<256;i++){
    let u = i/255; if(inv) u = 1-u; u = Math.pow(u, gamma); // apply invert + gamma
    // find segment
    const S = stops.length-1; const x = u*S; const i0 = Math.min(S-1, Math.floor(x)); const t = x - i0;
    const c0 = stops[i0], c1 = stops[i0+1];
    const r = Math.round(lerp(c0[0], c1[0], t));
    const g = Math.round(lerp(c0[1], c1[1], t));
    const b = Math.round(lerp(c0[2], c1[2], t));
    const o = i*3; LUT[o]=r; LUT[o+1]=g; LUT[o+2]=b;
  }
  // draw swatch
  const W = swatch.width|0, H = swatch.height|0; const img = swctx.createImageData(W,H);
  for(let x=0;x<W;x++){
    const u = x/(W-1); const k = Math.max(0, Math.min(255, Math.round(u*255))); const o3 = k*3;
    for(let y=0;y<H;y++){
      const p = (y*W + x)*4; img.data[p]=LUT[o3]; img.data[p+1]=LUT[o3+1]; img.data[p+2]=LUT[o3+2]; img.data[p+3]=255;
    }
  }
  swctx.putImageData(img,0,0);
}
buildPalette();

/* ======== Renderer ======== */
const colBuf = new Uint8ClampedArray((canvas.height|0) * 4); // 1px column buffer
let lastTime = performance.now();
let pxAccum = 0;

function step(nowMs){
  const now = nowMs || performance.now();
  if(running && !paused){
    const dt = (now - lastTime) / 1000; // seconds
    const pxPerSec = (canvas.width|0) / (+seconds.value);
    pxAccum += dt * pxPerSec;

    analyser.getFloatFrequencyData(freqBins);
    analyser.getFloatTimeDomainData(timeBuf);
    // mic RMS level meter
    let rms=0; for(let i=0;i<timeBuf.length;i++){ const v=timeBuf[i]; rms+=v*v; }
    rms = Math.sqrt(rms/timeBuf.length); lvlBar.style.width = Math.max(0, Math.min(100, 100*(rms/0.2))) + '%';

    const cols = Math.floor(pxAccum);
    if(cols>0){ pxAccum -= cols; paintSpectrogramColumns(cols); }
    lastTime = now;
  }
  drawGridOverlay();
  requestAnimationFrame(step);
}

function paintSpectrogramColumns(cols){
  const dyn = +dynSl.value; const dbMax = analyser.maxDecibels; const dbMin = dbMax - dyn;
  const H = canvas.height|0; const W = canvas.width|0;
  for(let y=0;y<H;y++){
    const i0 = y2bin[y]|0; const t  = y2frac[y];
    const v0 = freqBins[i0] ?? dbMin; const v1 = freqBins[i0+1] ?? v0;
    let u = (v0*(1-t) + v1*t - dbMin) / (dbMax - dbMin); // 0..1
    u = Math.max(0, Math.min(1, u));
    const k = (u*255)|0; const o3 = k*3;
    const o = ((H-1-y)<<2);
    colBuf[o+0]=LUT[o3]; colBuf[o+1]=LUT[o3+1]; colBuf[o+2]=LUT[o3+2]; colBuf[o+3]=255;
  }
  const img = new ImageData(colBuf, 1, H);
  for(let k=0;k<cols;k++){ ctx.drawImage(canvas, -1, 0); ctx.putImageData(img, W-1, 0); }
}

function drawGridOverlay(){
  const W = canvas.width|0, H = canvas.height|0; ctx.save(); ctx.globalAlpha = 0.1; ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 1;
  for(let y=100; y<H; y+=100){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }
  const tps = W/(+seconds.value);
  for(let x=W; x>=0; x-=tps){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
  ctx.restore();
}

/* ======== Controls ======== */
startBtn.onclick = async () => { try{ await initAudio(); audioCtx.resume(); running=true; paused=false; } catch(e){ alert('Microphone access failed: '+e.message); } };
pauseBtn.onclick = () => { if(!audioCtx) return; paused = !paused; pauseBtn.textContent = paused ? '‚ñ∂ Resume' : '‚è∏ Pause'; };
saveBtn.onclick  = () => { const a = document.createElement('a'); a.download = 'spectrogram.png'; a.href = canvas.toDataURL('image/png'); a.click(); };

/* ======== Init ======== */
function init(){ buildPalette(); rebuildYmap(); drawXTicks(); lastTime = performance.now(); requestAnimationFrame(step); }
init();
</script>
</body>
</html>
